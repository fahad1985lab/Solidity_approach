<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda">
<a id="2" class="Keyword">open</a> <a id="7" class="Keyword">import</a> <a id="14" href="constantparameters.html" class="Module">constantparameters</a>

<a id="34" class="Keyword">module</a> <a id="41" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html" class="Module">Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate</a> <a id="113" class="Symbol">(</a><a id="114" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="120" class="Symbol">:</a> <a id="122" href="constantparameters.html#235" class="Record">ConstantParameters</a><a id="140" class="Symbol">)</a> <a id="142" class="Keyword">where</a>

<a id="149" class="Keyword">open</a> <a id="154" class="Keyword">import</a> <a id="161" href="Data.Nat.html" class="Module">Data.Nat</a>
<a id="170" class="Keyword">open</a> <a id="175" class="Keyword">import</a> <a id="182" href="Agda.Builtin.Nat.html" class="Module">Agda.Builtin.Nat</a> <a id="199" class="Keyword">using</a> <a id="205" class="Symbol">(</a><a id="206" href="Agda.Builtin.Nat.html#426" class="Primitive Operator">_-_</a><a id="209" class="Symbol">;</a> <a id="211" href="Agda.Builtin.Nat.html#539" class="Primitive Operator">_*_</a><a id="214" class="Symbol">)</a>
<a id="216" class="Keyword">open</a> <a id="221" class="Keyword">import</a> <a id="228" href="Data.Unit.html" class="Module">Data.Unit</a>
<a id="238" class="Keyword">open</a> <a id="243" class="Keyword">import</a> <a id="250" href="Data.List.html" class="Module">Data.List</a>
<a id="260" class="Keyword">open</a> <a id="265" class="Keyword">import</a> <a id="272" href="Data.Bool.html" class="Module">Data.Bool</a>
<a id="282" class="Keyword">open</a> <a id="287" class="Keyword">import</a> <a id="294" href="Data.Bool.Base.html" class="Module">Data.Bool.Base</a>
<a id="309" class="Keyword">open</a> <a id="314" class="Keyword">import</a> <a id="321" href="Data.Nat.Base.html" class="Module">Data.Nat.Base</a>
<a id="335" class="Keyword">open</a> <a id="340" class="Keyword">import</a> <a id="347" href="Data.Maybe.html" class="Module">Data.Maybe</a>  <a id="359" class="Keyword">hiding</a> <a id="366" class="Symbol">(</a><a id="367" href="Data.Maybe.Base.html#2256" class="Function Operator">_&gt;&gt;=_</a><a id="372" class="Symbol">)</a>
<a id="374" class="Keyword">open</a> <a id="379" class="Keyword">import</a> <a id="386" href="Data.String.html" class="Module">Data.String</a> <a id="398" class="Keyword">hiding</a> <a id="405" class="Symbol">(</a><a id="406" href="Data.String.Base.html#2468" class="Function">length</a><a id="412" class="Symbol">;</a> <a id="414" href="Data.String.Base.html#1605" class="Primitive">show</a><a id="418" class="Symbol">)</a> <a id="420" class="Keyword">renaming</a> <a id="429" class="Symbol">(</a><a id="430" href="Data.String.Base.html#2404" class="Function Operator">_++_</a> <a id="435" class="Symbol">to</a> <a id="438" class="Function Operator">_++str_</a><a id="445" class="Symbol">)</a>
<a id="447" class="Keyword">open</a> <a id="452" class="Keyword">import</a> <a id="459" href="Data.Product.html" class="Module">Data.Product</a> <a id="472" class="Keyword">renaming</a> <a id="481" class="Symbol">(</a><a id="482" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">_,_</a> <a id="486" class="Symbol">to</a> <a id="489" class="InductiveConstructor Operator">_,,_</a> <a id="494" class="Symbol">)</a>
<a id="496" class="Keyword">open</a> <a id="501" class="Keyword">import</a> <a id="508" href="Data.Nat.Show.html" class="Module">Data.Nat.Show</a>
<a id="522" class="Keyword">open</a> <a id="527" class="Keyword">import</a> <a id="534" href="Data.Empty.html" class="Module">Data.Empty</a>


<a id="547" class="Comment">-- our work</a>
<a id="559" class="Keyword">open</a> <a id="564" class="Keyword">import</a> <a id="571" href="Complex-Model.ccomand.ccommands-cresponse.html" class="Module">Complex-Model.ccomand.ccommands-cresponse</a>
<a id="613" class="Keyword">open</a> <a id="618" class="Keyword">import</a> <a id="625" href="basicDataStructure.html" class="Module">basicDataStructure</a>
<a id="644" class="Keyword">open</a> <a id="649" class="Keyword">import</a> <a id="656" href="libraries.natCompare.html" class="Module">libraries.natCompare</a>
<a id="677" class="Keyword">open</a> <a id="682" class="Keyword">import</a> <a id="689" href="libraries.Mainlibrary-new-version.html" class="Module">libraries.Mainlibrary-new-version</a>
<a id="723" class="Keyword">open</a> <a id="728" class="Keyword">import</a> <a id="735" href="Complex-Model.ledgerversion.Ledger-Complex-Model-with-reentrancy-attack.html" class="Module">Complex-Model.ledgerversion.Ledger-Complex-Model-with-reentrancy-attack</a>






<a id="813" class="Symbol">{-#</a> <a id="817" class="Keyword">NON_TERMINATING</a> <a id="833" class="Symbol">#-}</a>
<a id="evaluateNonTerminatingStep2"></a><a id="837" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#837" class="Function">evaluateNonTerminatingStep2</a> <a id="865" class="Symbol">:</a> <a id="867" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a> <a id="874" class="Symbol">→</a> <a id="876" href="libraries.Mainlibrary-new-version.html#1548" class="Record">StateExecFun</a> <a id="889" class="Symbol">→</a> <a id="891" class="Symbol">(</a><a id="892" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a> <a id="899" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="901" href="basicDataStructure.html#1700" class="Record">MsgOrErrorWithGas</a><a id="918" class="Symbol">)</a>
<a id="920" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#837" class="Function">evaluateNonTerminatingStep2</a> <a id="948" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#948" class="Bound">oldLedger</a> <a id="958" class="Symbol">(</a><a id="959" href="libraries.Mainlibrary-new-version.html#1587" class="InductiveConstructor">stateEF</a> <a id="967" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#967" class="Bound">currentLedger</a> <a id="981" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a> <a id="984" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#984" class="Bound">initialAddr</a> <a id="996" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#996" class="Bound">lastCallAddr</a> <a id="1009" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1009" class="Bound">calledAddr</a> <a id="1020" class="Symbol">(</a><a id="1021" href="Complex-Model.ccomand.ccommands-cresponse.html#1802" class="InductiveConstructor">return</a> <a id="1028" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1028" class="Bound">msg</a><a id="1031" class="Symbol">)</a> <a id="1033" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1033" class="Bound">gasLeft</a> <a id="1041" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1041" class="Bound">funNameevalState</a> <a id="1058" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1058" class="Bound">msgevalState</a> <a id="1071" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1071" class="Bound">amountReceived</a> <a id="1086" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1086" class="Bound">listEvent</a><a id="1095" class="Symbol">)</a>
                            <a id="1125" class="Symbol">=</a>
                                <a id="1159" href="Complex-Model.ledgerversion.Ledger-Complex-Model-with-reentrancy-attack.html#33728" class="Function">evaluateAuxfinalStep3</a> <a id="1181" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="1187" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#948" class="Bound">oldLedger</a> <a id="1197" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#967" class="Bound">currentLedger</a> <a id="1211" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#984" class="Bound">initialAddr</a> <a id="1223" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#996" class="Bound">lastCallAddr</a> <a id="1236" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1009" class="Bound">calledAddr</a> <a id="1247" class="Symbol">(</a><a id="1248" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="1254" class="Symbol">.</a><a id="1255" href="constantparameters.html#553" class="Field">costofreturn</a><a id="1267" class="Symbol">)</a>
                                <a id="1301" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1028" class="Bound">msg</a> <a id="1305" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1033" class="Bound">gasLeft</a> <a id="1313" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1041" class="Bound">funNameevalState</a> <a id="1330" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1058" class="Bound">msgevalState</a> <a id="1343" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1071" class="Bound">amountReceived</a> 
                                <a id="1391" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1086" class="Bound">listEvent</a> <a id="1401" class="Symbol">(</a><a id="1402" href="libraries.natCompare.html#901" class="Function">compareLeq</a> <a id="1413" class="Symbol">(</a><a id="1414" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="1420" class="Symbol">.</a><a id="1421" href="constantparameters.html#553" class="Field">costofreturn</a><a id="1433" class="Symbol">)</a> <a id="1435" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1033" class="Bound">gasLeft</a><a id="1442" class="Symbol">)</a>
<a id="1444" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#837" class="CatchallClause Function">evaluateNonTerminatingStep2</a><a id="1471" class="CatchallClause"> </a><a id="1472" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1472" class="CatchallClause Bound">oldLedger</a><a id="1481" class="CatchallClause"> </a><a id="1482" class="CatchallClause Symbol">(</a><a id="1483" href="libraries.Mainlibrary-new-version.html#1587" class="CatchallClause InductiveConstructor">stateEF</a><a id="1490" class="CatchallClause"> </a><a id="1491" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1491" class="CatchallClause Bound">currentLedger</a><a id="1504" class="CatchallClause"> </a><a id="1505" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1505" class="CatchallClause Bound">s</a><a id="1506" class="CatchallClause"> </a><a id="1507" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1507" class="CatchallClause Bound">initialAddr</a><a id="1518" class="CatchallClause"> </a><a id="1519" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1519" class="CatchallClause Bound">lastCallAddr</a><a id="1531" class="CatchallClause"> </a><a id="1532" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1532" class="CatchallClause Bound">calledAddr</a><a id="1542" class="CatchallClause"> </a><a id="1543" class="CatchallClause Symbol">(</a><a id="1544" href="Complex-Model.ccomand.ccommands-cresponse.html#1836" class="CatchallClause InductiveConstructor">error</a><a id="1549" class="CatchallClause"> </a><a id="1550" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1550" class="CatchallClause Bound">msgg</a><a id="1554" class="CatchallClause"> </a><a id="1555" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1555" class="CatchallClause Bound">debugInfo</a><a id="1564" class="CatchallClause Symbol">)</a>
                             <a id="1595" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1595" class="CatchallClause Bound">gasLeft</a><a id="1602" class="CatchallClause">  </a><a id="1604" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1604" class="CatchallClause Bound">funNameevalState</a><a id="1620" class="CatchallClause"> </a><a id="1621" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1621" class="CatchallClause Bound">msgevalState</a><a id="1633" class="CatchallClause"> </a><a id="1634" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1634" class="CatchallClause Bound">amountReceived</a><a id="1648" class="CatchallClause"> </a><a id="1649" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1649" class="CatchallClause Bound">listEvent</a><a id="1658" class="CatchallClause Symbol">)</a>
                          <a id="1686" class="Symbol">=</a> <a id="1688" href="Complex-Model.ledgerversion.Ledger-Complex-Model-with-reentrancy-attack.html#3373" class="Function">addWeiToLedger</a> <a id="1703" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="1709" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1472" class="Bound">oldLedger</a> <a id="1719" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1507" class="Bound">initialAddr</a> <a id="1731" class="Symbol">(</a><a id="1732" href="constantparameters.html#599" class="Function">GastoWei</a> <a id="1741" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="1747" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1595" class="Bound">gasLeft</a><a id="1754" class="Symbol">)</a> <a id="1756" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#489" class="InductiveConstructor Operator">,,</a>
                            <a id="1787" class="Symbol">((</a><a id="1789" href="basicDataStructure.html#1615" class="InductiveConstructor">err</a> <a id="1793" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1550" class="Bound">msgg</a> <a id="1798" href="basicDataStructure.html#892" class="InductiveConstructor Operator">⟨</a> <a id="1800" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1519" class="Bound">lastCallAddr</a> <a id="1813" href="basicDataStructure.html#892" class="InductiveConstructor Operator">&gt;&gt;</a> <a id="1816" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1507" class="Bound">initialAddr</a> <a id="1828" href="basicDataStructure.html#892" class="InductiveConstructor Operator">∙</a> <a id="1830" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1604" class="Bound">funNameevalState</a> <a id="1847" href="basicDataStructure.html#892" class="InductiveConstructor Operator">[</a> <a id="1849" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1621" class="Bound">msgevalState</a> <a id="1862" href="basicDataStructure.html#892" class="InductiveConstructor Operator">]∙</a> <a id="1865" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1649" class="Bound">listEvent</a> <a id="1875" href="basicDataStructure.html#892" class="InductiveConstructor Operator">⟩</a><a id="1876" class="Symbol">)</a> <a id="1878" href="basicDataStructure.html#1751" class="InductiveConstructor Operator">,</a> <a id="1880" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1595" class="Bound">gasLeft</a> <a id="1888" href="basicDataStructure.html#1751" class="InductiveConstructor Operator">gas,</a> <a id="1893" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1649" class="Bound">listEvent</a><a id="1902" class="Symbol">)</a>
                            
<a id="1933" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#837" class="CatchallClause Function">evaluateNonTerminatingStep2</a><a id="1960" class="CatchallClause"> </a><a id="1961" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1961" class="CatchallClause Bound">oldLedger</a><a id="1970" class="CatchallClause"> </a><a id="1971" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1971" class="CatchallClause Bound">evals</a> <a id="1977" class="Symbol">=</a> <a id="1979" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#837" class="Function">evaluateNonTerminatingStep2</a> <a id="2007" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1961" class="Bound">oldLedger</a> <a id="2017" class="Symbol">(</a><a id="2018" href="Complex-Model.ledgerversion.Ledger-Complex-Model-with-reentrancy-attack.html#26178" class="Function">stepEFwithGasError</a> <a id="2037" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="2043" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1961" class="Bound">oldLedger</a> <a id="2053" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#1971" class="Bound">evals</a><a id="2058" class="Symbol">)</a>



<a id="evaluateNonTerminatingStep1"></a><a id="2063" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2063" class="Function">evaluateNonTerminatingStep1</a> <a id="2091" class="Symbol">:</a> <a id="2093" class="Symbol">(</a><a id="2094" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2094" class="Bound">ledger</a> <a id="2101" class="Symbol">:</a> <a id="2103" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a><a id="2109" class="Symbol">)</a>
                          <a id="2137" class="Symbol">→</a> <a id="2139" class="Symbol">(</a><a id="2140" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2140" class="Bound">initialAddr</a> <a id="2152" class="Symbol">:</a> <a id="2154" href="basicDataStructure.html#387" class="Function">Address</a><a id="2161" class="Symbol">)</a>
                          <a id="2189" class="Symbol">→</a> <a id="2191" class="Symbol">(</a><a id="2192" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2192" class="Bound">lastCallAddr</a> <a id="2205" class="Symbol">:</a> <a id="2207" href="basicDataStructure.html#387" class="Function">Address</a><a id="2214" class="Symbol">)</a>
                          <a id="2242" class="Symbol">→</a> <a id="2244" class="Symbol">(</a><a id="2245" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2245" class="Bound">calledAddr</a> <a id="2256" class="Symbol">:</a> <a id="2258" href="basicDataStructure.html#387" class="Function">Address</a><a id="2265" class="Symbol">)</a>
                          <a id="2293" class="Symbol">→</a> <a id="2295" class="Symbol">(</a><a id="2296" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2296" class="Bound">gasreserved</a> <a id="2308" class="Symbol">:</a> <a id="2310" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="2311" class="Symbol">)</a>
                          <a id="2339" class="Symbol">→</a> <a id="2341" href="basicDataStructure.html#173" class="Function">FunctionName</a>
                          <a id="2380" class="Symbol">→</a> <a id="2382" href="basicDataStructure.html#511" class="Datatype">Msg</a>                          
                          <a id="2438" class="Symbol">→</a> <a id="2440" class="Symbol">(</a><a id="2441" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2441" class="Bound">amountReceived</a> <a id="2456" class="Symbol">:</a> <a id="2458" href="basicDataStructure.html#360" class="Function">Amount</a><a id="2464" class="Symbol">)</a>
                          <a id="2492" class="Symbol">→</a> <a id="2494" class="Symbol">(</a><a id="2495" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2495" class="Bound">listEvent</a> <a id="2505" class="Symbol">:</a> <a id="2507" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2512" href="Agda.Builtin.String.html#335" class="Postulate">String</a><a id="2518" class="Symbol">)</a>
                          <a id="2546" class="Symbol">→</a> <a id="2548" class="Symbol">(</a><a id="2549" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2549" class="Bound">cp</a>  <a id="2553" class="Symbol">:</a> <a id="2555" href="libraries.natCompare.html#644" class="Datatype">OrderingLeq</a> <a id="2567" class="Symbol">(</a><a id="2568" href="constantparameters.html#599" class="Function">GastoWei</a> <a id="2577" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="2583" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2296" class="Bound">gasreserved</a><a id="2594" class="Symbol">)</a> <a id="2596" class="Symbol">(</a><a id="2597" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2094" class="Bound">ledger</a> <a id="2604" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2140" class="Bound">initialAddr</a> <a id="2616" class="Symbol">.</a><a id="2617" href="libraries.Mainlibrary-new-version.html#827" class="Field">amount</a><a id="2623" class="Symbol">))</a>
                          <a id="2652" class="Symbol">→</a> <a id="2654" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="2660" class="Symbol">(</a><a id="2661" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a> <a id="2668" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="2670" href="basicDataStructure.html#1700" class="Record">MsgOrErrorWithGas</a><a id="2687" class="Symbol">)</a>
<a id="2689" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2063" class="Function">evaluateNonTerminatingStep1</a> <a id="2717" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2717" class="Bound">ledger</a> <a id="2724" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2724" class="Bound">initialAddr</a> <a id="2736" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2736" class="Bound">lastCallAddr</a> <a id="2749" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2749" class="Bound">calledAddr</a> <a id="2760" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2760" class="Bound">gasreserved</a> <a id="2772" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2772" class="Bound">funname</a> <a id="2780" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2780" class="Bound">msg</a>  <a id="2785" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2785" class="Bound">amountReceived</a> <a id="2800" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2800" class="Bound">listEvent</a> <a id="2810" class="Symbol">(</a><a id="2811" href="libraries.natCompare.html#682" class="InductiveConstructor">leq</a> <a id="2815" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2815" class="Bound">leqpr</a><a id="2820" class="Symbol">)</a>
                           <a id="2849" class="Symbol">=</a> <a id="2851" class="Keyword">let</a>
                               <a id="2886" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2886" class="Bound">ledgerDeducted</a> <a id="2901" class="Symbol">:</a> <a id="2903" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a>
                               <a id="2941" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2886" class="Bound">ledgerDeducted</a> <a id="2956" class="Symbol">=</a> <a id="2958" href="Complex-Model.ledgerversion.Ledger-Complex-Model-with-reentrancy-attack.html#2543" class="Function">deductGasFromLedger</a> <a id="2978" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="2984" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2717" class="Bound">ledger</a> <a id="2991" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2724" class="Bound">initialAddr</a> <a id="3003" class="Symbol">(</a><a id="3004" href="constantparameters.html#599" class="Function">GastoWei</a> <a id="3013" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="3019" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2760" class="Bound">gasreserved</a><a id="3030" class="Symbol">)</a> <a id="3032" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2815" class="Bound">leqpr</a>
                             <a id="3067" class="Keyword">in</a> <a id="3070" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="3075" class="Symbol">(</a><a id="3076" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#837" class="Function">evaluateNonTerminatingStep2</a> <a id="3104" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2886" class="Bound">ledgerDeducted</a>

   <a id="3123" class="Symbol">(</a><a id="3124" href="libraries.Mainlibrary-new-version.html#1587" class="InductiveConstructor">stateEF</a> <a id="3132" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2886" class="Bound">ledgerDeducted</a> <a id="3147" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a> <a id="3150" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2724" class="Bound">initialAddr</a> <a id="3162" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2724" class="Bound">initialAddr</a>  <a id="3175" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2736" class="Bound">lastCallAddr</a> <a id="3188" class="Symbol">(</a><a id="3189" href="Complex-Model.ccomand.ccommands-cresponse.html#1889" class="InductiveConstructor">exec</a> <a id="3194" class="Symbol">(</a><a id="3195" href="Complex-Model.ccomand.ccommands-cresponse.html#486" class="InductiveConstructor">callc</a> <a id="3201" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2749" class="Bound">calledAddr</a> <a id="3212" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2772" class="Bound">funname</a> <a id="3220" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2780" class="Bound">msg</a>  <a id="3225" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2785" class="Bound">amountReceived</a><a id="3239" class="Symbol">)</a> <a id="3241" class="Symbol">(λ</a> <a id="3244" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3244" class="Bound">_</a> <a id="3246" class="Symbol">→</a> <a id="3248" class="Number">1</a><a id="3249" class="Symbol">)</a> <a id="3251" href="Complex-Model.ccomand.ccommands-cresponse.html#1802" class="InductiveConstructor">return</a><a id="3257" class="Symbol">)</a> 
                               <a id="3291" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2760" class="Bound">gasreserved</a>  <a id="3304" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2772" class="Bound">funname</a> <a id="3312" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2780" class="Bound">msg</a>  <a id="3317" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2785" class="Bound">amountReceived</a> <a id="3332" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2800" class="Bound">listEvent</a><a id="3341" class="Symbol">))</a>

<a id="3345" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2063" class="Function">evaluateNonTerminatingStep1</a> <a id="3373" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3373" class="Bound">ledger</a> <a id="3380" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3380" class="Bound">initialAddr</a> <a id="3392" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3392" class="Bound">lastCallAddr</a> <a id="3405" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3405" class="Bound">calledAddr</a> <a id="3416" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3416" class="Bound">gasreserved</a> <a id="3428" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3428" class="Bound">funname</a> <a id="3436" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3436" class="Bound">msg</a>  <a id="3441" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3441" class="Bound">amountReceived</a> <a id="3456" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3456" class="Bound">listEvent</a> <a id="3466" class="Symbol">(</a><a id="3467" href="libraries.natCompare.html#720" class="InductiveConstructor">greater</a> <a id="3475" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3475" class="Bound">greaterpr</a><a id="3484" class="Symbol">)</a>
                           <a id="3513" class="Symbol">=</a> <a id="3515" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>


<a id="evaluateNonTerminatingfinalstep"></a><a id="3525" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3525" class="Function">evaluateNonTerminatingfinalstep</a> <a id="3557" class="Symbol">:</a> <a id="3559" class="Symbol">(</a><a id="3560" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3560" class="Bound">ledger</a> <a id="3567" class="Symbol">:</a> <a id="3569" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a><a id="3575" class="Symbol">)</a>
                         <a id="3602" class="Symbol">→</a> <a id="3604" class="Symbol">(</a><a id="3605" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3605" class="Bound">initialAddr</a> <a id="3617" class="Symbol">:</a> <a id="3619" href="basicDataStructure.html#387" class="Function">Address</a><a id="3626" class="Symbol">)</a>
                            <a id="3656" class="Comment">-- Initial address is the address from which the very first call was made</a>
                         <a id="3755" class="Symbol">→</a> <a id="3757" class="Symbol">(</a><a id="3758" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3758" class="Bound">lastCallAddr</a> <a id="3771" class="Symbol">:</a> <a id="3773" href="basicDataStructure.html#387" class="Function">Address</a><a id="3780" class="Symbol">)</a>
                            <a id="3810" class="Comment">-- lastCallAddr is the address from which the current call of a function in</a>
                            <a id="3914" class="Comment">--         calledAddr is made</a>
                         <a id="3969" class="Symbol">→</a> <a id="3971" class="Symbol">(</a><a id="3972" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3972" class="Bound">calledAddr</a> <a id="3983" class="Symbol">:</a> <a id="3985" href="basicDataStructure.html#387" class="Function">Address</a><a id="3992" class="Symbol">)</a>
                            <a id="4022" class="Comment">-- calledAddr is the address where a function call is currently executed</a>
                            <a id="4123" class="Comment">--            it was called from calledAddr</a>
                         <a id="4192" class="Symbol">→</a> <a id="4194" class="Symbol">(</a><a id="4195" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4195" class="Bound">gasreserved</a> <a id="4207" class="Symbol">:</a> <a id="4209" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="4210" class="Symbol">)</a>
                         <a id="4237" class="Symbol">→</a> <a id="4239" href="basicDataStructure.html#173" class="Function">FunctionName</a>
                         <a id="4277" class="Symbol">→</a> <a id="4279" href="basicDataStructure.html#511" class="Datatype">Msg</a>
                         <a id="4308" class="Symbol">→</a> <a id="4310" class="Symbol">(</a><a id="4311" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4311" class="Bound">amountReceived</a> <a id="4326" class="Symbol">:</a> <a id="4328" href="basicDataStructure.html#360" class="Function">Amount</a><a id="4334" class="Symbol">)</a>
                         <a id="4361" class="Symbol">→</a> <a id="4363" class="Symbol">(</a><a id="4364" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4364" class="Bound">listEvent</a> <a id="4374" class="Symbol">:</a> <a id="4376" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="4381" href="Agda.Builtin.String.html#335" class="Postulate">String</a><a id="4387" class="Symbol">)</a>
                         <a id="4414" class="Symbol">→</a> <a id="4416" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="4422" class="Symbol">(</a><a id="4423" href="libraries.Mainlibrary-new-version.html#1040" class="Function">Ledger</a> <a id="4430" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="4432" href="basicDataStructure.html#1700" class="Record">MsgOrErrorWithGas</a><a id="4449" class="Symbol">)</a>
<a id="4451" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#3525" class="Function">evaluateNonTerminatingfinalstep</a> <a id="4483" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4483" class="Bound">ledger</a> <a id="4490" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4490" class="Bound">initialAddr</a> <a id="4502" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4502" class="Bound">lastCallAddr</a> <a id="4515" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4515" class="Bound">calledAddr</a> <a id="4526" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4526" class="Bound">gasreserved</a> <a id="4538" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4538" class="Bound">funname</a> <a id="4546" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4546" class="Bound">msg</a>  <a id="4551" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4551" class="Bound">amountReceived</a> <a id="4566" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4566" class="Bound">listEvent</a>
                      <a id="4598" class="Symbol">=</a>  <a id="4601" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#2063" class="Function">evaluateNonTerminatingStep1</a> <a id="4629" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4483" class="Bound">ledger</a> <a id="4636" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4490" class="Bound">initialAddr</a> <a id="4648" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4502" class="Bound">lastCallAddr</a> <a id="4661" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4515" class="Bound">calledAddr</a> <a id="4672" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4526" class="Bound">gasreserved</a> <a id="4684" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4538" class="Bound">funname</a> <a id="4692" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4546" class="Bound">msg</a> <a id="4696" class="Comment">{-(nat 100)-}</a>  <a id="4711" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4551" class="Bound">amountReceived</a> <a id="4726" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4566" class="Bound">listEvent</a>
                         <a id="4761" class="Symbol">(</a><a id="4762" href="libraries.natCompare.html#901" class="Function">compareLeq</a> <a id="4773" class="Symbol">(</a><a id="4774" href="constantparameters.html#599" class="Function">GastoWei</a> <a id="4783" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#114" class="Bound">param</a> <a id="4789" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4526" class="Bound">gasreserved</a><a id="4800" class="Symbol">)</a> <a id="4802" class="Symbol">(</a><a id="4803" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4483" class="Bound">ledger</a> <a id="4810" href="Complex-Model.ledgerversion.Ledger-Complex-Model-improved-non-terminate.html#4490" class="Bound">initialAddr</a> <a id="4822" class="Symbol">.</a><a id="4823" href="libraries.Mainlibrary-new-version.html#827" class="Field">amount</a><a id="4829" class="Symbol">))</a>

















































































 <a id="4914" class="Comment">---##################################################################################</a>
<a id="5000" class="Comment">{- before add listevent to MsgOrErrorWithGas



{-# NON_TERMINATING #-}
evaluateNonTerminatingStep2 : Ledger → StateExecFun → (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingStep2 oldLedger (stateEF currentLedger [] initialAddr lastCallAddr calledAddr (return msg) gasLeft funNameevalState msgevalState amountReceived listEvent)   =
                                evaluateAuxfinalStep3 param oldLedger currentLedger initialAddr lastCallAddr calledAddr (param .costofreturn)
                                msg {- if i chang it to (nat 100) it works, but with msg does not work-}
                                gasLeft funNameevalState msgevalState amountReceived listEvent (compareLeq (param .costofreturn) gasLeft)
evaluateNonTerminatingStep2 oldLedger (stateEF currentLedger s initialAddr lastCallAddr calledAddr (error msgg debugInfo)
                             gasLeft  funNameevalState msgevalState amountReceived listEvent)
                          = addWeiToLedger param oldLedger initialAddr (GastoWei param gasLeft) ,,
                            ((err msgg
                            --⟨  lastCallAddr &gt;&gt; initialAddr ∙ funNameevalState [ msgevalState ]⟩
                            ⟨ lastCallAddr &gt;&gt; initialAddr ∙ funNameevalState [ msgevalState ]∙ listEvent ⟩) , gasLeft gas)
                            
evaluateNonTerminatingStep2 oldLedger evals = evaluateNonTerminatingStep2 oldLedger (stepEFwithGasError param oldLedger evals)

{- old

evaluateNonTerminatingAuxfinal0 : Ledger → StateExecFun → (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingAuxfinal0 oldLedger (stateEF currentLedger [] initialAddr lastCallAddr calledAddr (return cost ms)
                            gasLeft  funNameevalState msgevalState)
                            = evaluateAuxfinal0&#39; param oldLedger currentLedger
                                initialAddr lastCallAddr calledAddr cost ms gasLeft funNameevalState msgevalState (compareLeq cost gasLeft)

evaluateNonTerminatingAuxfinal0 oldLedger (stateEF currentLedger s initialAddr lastCallAddr calledAddr (error msgg debugInfo)
                             gasLeft  funNameevalState msgevalState)
                          = addWeiToLedger param oldLedger initialAddr (GastoWei param gasLeft) ,,
                            (err msgg ⟨  lastCallAddr &gt;&gt; initialAddr ∙ funNameevalState [ msgevalState ]⟩ , gasLeft gas)
evaluateNonTerminatingAuxfinal0 oldLedger evals
                          = evaluateNonTerminatingAuxfinal0 oldLedger (stepEFwithGasError param oldLedger evals)



-}


evaluateNonTerminatingStep1 : (ledger : Ledger)
                          → (initialAddr : Address)
                          → (lastCallAddr : Address)
                          → (calledAddr : Address)
                          → (gasreserved : ℕ)
                          → FunctionName
                          → Msg                          
                          → (amountReceived : Amount)
                          → (listEvent : List String)
                          → (cp  : OrderingLeq (GastoWei param gasreserved) (ledger initialAddr .amount))
                          → Maybe (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingStep1 ledger initialAddr lastCallAddr calledAddr gasreserved funname msg  amountReceived listEvent (leq leqpr)
                           = let
                               ledgerDeducted : Ledger
                               ledgerDeducted = deductGasFromLedger param ledger initialAddr (GastoWei param gasreserved) leqpr
                             in just (evaluateNonTerminatingStep2 ledgerDeducted

   (stateEF ledgerDeducted [] initialAddr initialAddr  lastCallAddr (exec (callc calledAddr funname msg  amountReceived) (λ _ → 1) return) 
                               gasreserved  funname msg  amountReceived listEvent))

evaluateNonTerminatingStep1 ledger initialAddr lastCallAddr calledAddr gasreserved funname msg  amountReceived listEvent (greater greaterpr)
                           = nothing
{-
{- old version
                               (ledgerDeducted calledAddr .fun funname msg)
                               notes : execute the body of the function old solution and did not execute the transfer
                             the new solution it will execute the function even transfer and when finish it will return -}
                             -- old version
-- (stateEF ledgerDeducted [] initialAddr lastCallAddr calledAddr (exec (callc calledAddr funname msg amountReceived) (λ _ → 1) return)
-}

evaluateNonTerminatingfinalstep : (ledger : Ledger)
                         → (initialAddr : Address)
                            -- Initial address is the address from which the very first call was made
                         → (lastCallAddr : Address)
                            -- lastCallAddr is the address from which the current call of a function in
                            --         calledAddr is made
                         → (calledAddr : Address)
                            -- calledAddr is the address where a function call is currently executed
                            --            it was called from calledAddr
                         → (gasreserved : ℕ)
                         → FunctionName
                         → Msg
                         → (amountReceived : Amount)
                         → (listEvent : List String)
                         → Maybe (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingfinalstep ledger initialAddr lastCallAddr calledAddr gasreserved funname msg  amountReceived listEvent
                      =  evaluateNonTerminatingStep1 ledger initialAddr lastCallAddr calledAddr gasreserved funname msg {-(nat 100)-}  amountReceived listEvent
                         (compareLeq (GastoWei param gasreserved) (ledger initialAddr .amount))





-}</a>






<a id="10841" class="Comment">{- old version

change order

from
             → (amountReceived : Amount)
             → (gasreserved : ℕ)

to
             → (gasreserved : ℕ)
             → (amountReceived : Amount)

evaluateNonTerminatingAuxfinal : (ledger : Ledger)
                          → (initialAddr : Address)
                          → (lastCallAddr : Address)
                          → (calledAddr : Address)
                          → FunctionName
                          → Msg
                          → (amountReceived : Amount)
                          → (gasreserved : ℕ)
                          → (cp  : OrderingLeq (GastoWei param gasreserved) (ledger initialAddr .amount))
                          → Maybe (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingAuxfinal ledger initialAddr lastCallAddr calledAddr funname msg amountReceived gasreserved  (leq leqpr)
                           = let
                               ledgerDeducted : Ledger
                               ledgerDeducted = deductGasFromLedger param ledger initialAddr (GastoWei param gasreserved) leqpr
                             in just (evaluateNonTerminatingAuxfinal0 ledgerDeducted
                                     (stateEF ledgerDeducted [] initialAddr lastCallAddr calledAddr (ledgerDeducted calledAddr .fun funname msg)
                                     gasreserved  funname msg amountReceived))

evaluateNonTerminatingAuxfinal ledger initialAddr lastCallAddr calledAddr funname msg amountReceived gasreserved  (greater greaterpr)
                           = nothing


evaluateNonTerminatingfinal : (ledger : Ledger)
                         → (initialAddr : Address)
                            -- Initial address is the address from which the very first call was made
                         → (lastCallAddr : Address)
                            -- lastCallAddr is the address from which the current call of a function in
                            --         calledAddr is made
                         → (calledAddr : Address)
                            -- calledAddr is the address where a function call is currently executed
                            --            it was called from calledAddr
                         → FunctionName
                         → Msg
                         → (amountReceived : Amount)
                         → (gasreserved : ℕ)
                         → Maybe (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingfinal ledger initialAddr lastCallAddr calledAddr funname msg amountReceived gasreserved
                      =  evaluateNonTerminatingAuxfinal ledger initialAddr lastCallAddr calledAddr funname msg amountReceived gasreserved
                         (compareLeq (GastoWei param gasreserved) (ledger initialAddr .amount))










-}</a>


<a id="13631" class="Comment">----#######</a>

<a id="13644" class="Comment">{- old version on 29.11.2023

evaluateAuxfinalStep3 : (oldLedger : Ledger)
                          → (currentLedger : Ledger)
                          → (initialAddr : Address)
                          → (lastCallAddr : Address)
                          → (calledAddr : Address)
                          → (cost : ℕ)
                          → (returnvalue : Msg)
                          → (gasLeft : ℕ)
                          → (funNameevalState : FunctionName)
                          → (msgevalState : Msg)
                          → (amountReceived : Amount)
                          → (cp  : OrderingLeq cost gasLeft)
                          → (Ledger × MsgOrErrorWithGas)
evaluateAuxfinalStep3 oldLedger currentLedger initialAddr lastCallAddr calledAddr cost ms gasLeft funNameevalState msgevalState amountReceived (leq x)
                               =  (addWeiToLedger param currentLedger initialAddr
                                   (GastoWei param (gasLeft - cost))) ,, ((theMsg ms) , ((gasLeft - cost)) gas)
                                 -- test this function by replacing ms to (nat 100) and it works
evaluateAuxfinalStep3 oldLedger currentLedger initialAddr lastCallAddr calledAddr cost returnvalue gasLeft funNameevalState msgevalState amountReceived (greater x)
                               = oldLedger ,, (((err (strErr &quot; Out Of Gass &quot;) ⟨ lastCallAddr &gt;&gt; initialAddr ∙ funNameevalState [ msgevalState ]⟩) , gasLeft gas))




{-# NON_TERMINATING #-}
evaluateNonTerminatingStep2 : Ledger → StateExecFun → (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingStep2 oldLedger (stateEF currentLedger [] initialAddr lastCallAddr calledAddr (return msg) gasLeft funNameevalState msgevalState amountReceived)   =
                                evaluateAuxfinalStep3 {-param-} oldLedger currentLedger initialAddr lastCallAddr calledAddr (param .costofreturn)
                                msg {- if i chang it to (nat 100) it works, but with msg does not work-}
                                gasLeft funNameevalState msgevalState amountReceived (compareLeq (param .costofreturn) gasLeft)
evaluateNonTerminatingStep2 oldLedger (stateEF currentLedger s initialAddr lastCallAddr calledAddr (error msgg debugInfo)
                             gasLeft  funNameevalState msgevalState amountReceived)
                          = addWeiToLedger param oldLedger initialAddr (GastoWei param gasLeft) ,,
                            ((err msgg ⟨  lastCallAddr &gt;&gt; initialAddr ∙ funNameevalState [ msgevalState ]⟩) , gasLeft gas)
                            
evaluateNonTerminatingStep2 oldLedger evals = evaluateNonTerminatingStep2 oldLedger (stepEFwithGasError param oldLedger evals)


evaluateNonTerminatingStep1 : (ledger : Ledger)
                          → (initialAddr : Address)
                          → (lastCallAddr : Address)
                          → (calledAddr : Address)
                          → FunctionName
                          → Msg
                          → (gasreserved : ℕ)
                          → (amountReceived : Amount)
                          → (cp  : OrderingLeq (GastoWei param gasreserved) (ledger initialAddr .amount))
                          → Maybe (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingStep1 ledger initialAddr lastCallAddr calledAddr funname msg gasreserved amountReceived (leq leqpr)
                           = let
                               ledgerDeducted : Ledger
                               ledgerDeducted = deductGasFromLedger param ledger initialAddr (GastoWei param gasreserved) leqpr
                             in just (evaluateNonTerminatingStep2 ledgerDeducted

   (stateEF ledgerDeducted [] initialAddr initialAddr  lastCallAddr (exec (callc calledAddr funname msg  amountReceived) (λ _ → 1) return) 
                               gasreserved  funname msg  amountReceived))

evaluateNonTerminatingStep1 ledger initialAddr lastCallAddr calledAddr funname msg gasreserved amountReceived (greater greaterpr)
                           = nothing


evaluateNonTerminatingfinalstep : (ledger : Ledger)
                         → (initialAddr : Address)
                            -- Initial address is the address from which the very first call was made
                         → (lastCallAddr : Address)
                            -- lastCallAddr is the address from which the current call of a function in
                            --         calledAddr is made
                         → (calledAddr : Address)
                            -- calledAddr is the address where a function call is currently executed
                            --            it was called from calledAddr
                         → FunctionName
                         → Msg
                         → (gasreserved : ℕ)
                         → (amountReceived : Amount)
                         → Maybe (Ledger × MsgOrErrorWithGas)
evaluateNonTerminatingfinalstep ledger initialAddr lastCallAddr calledAddr funname msg gasreserved amountReceived
                      =  evaluateNonTerminatingStep1 ledger initialAddr lastCallAddr calledAddr funname msg {-(nat 100)-} gasreserved amountReceived
                         (compareLeq (GastoWei param gasreserved) (ledger initialAddr .amount))


-}</a>
</pre></body></html>